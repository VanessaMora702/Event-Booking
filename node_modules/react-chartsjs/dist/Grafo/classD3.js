import*as D3 from'd3';import{MIN_HEIGHT,MIN_WIDTH,DEFAULT_COLOR}from'./defaultValues';export default(function(){var a=void 0,b=void 0,c=void 0,e=void 0,f=void 0,g=void 0,d={},h={},i=function(a,d){var e=h,f=e.chart,g=f.parentNode,i=g.offsetHeight,j=g.offsetWidth;c=a||i,b=d||j,('number'!=typeof c||c<MIN_HEIGHT)&&(console.warn('Invalid/small height provided, falling back to minimum value of '+MIN_HEIGHT),c=MIN_HEIGHT),('number'!=typeof b||b<MIN_WIDTH)&&(console.warn('Invalid/small width provided, falling back to minimum value of '+MIN_HEIGHT),b=MIN_HEIGHT)},j=function(a){return 0<=a&&1>=a},k=function(a,c,d){var e=parseInt(D3.select(a[c]).attr('r'),10),f=d;return f+e>b&&(f=b-e),0>f-e&&(f=0+e),f},l=function(a,b,d){var e=parseInt(D3.select(a[b]).attr('r'),10),f=d;return f+e>c&&(f=c-e),0>f-e&&(f=0+e),f},m=function(a){var b=a.nodes.map(function(a){return a.value});e=b.reduce(function(a,b){return a>b?a:b})},n=function(a,b){var c=Object.keys(b).includes(a.type);return c?b[a.type]:a.value*(f/2)/e+g/2},o=function(a,b,c){var d=Object.keys(b).includes(a.group.toString());return d?b[a.group]:c},p=function(a,b,c){return c+parseInt(D3.select(b._groups[0][a.index]).attr('r'),10)},q=function(a){return D3.drag().on('start',function dragstarted(b){D3.event.active||a.alphaTarget(.3).restart(),b.fx=b.x,b.fy=b.y}).on('drag',function dragged(a,b,c){a.fx=k(c,b,D3.event.x),a.fy=l(c,b,D3.event.y)}).on('end',function dragended(b){D3.event.active||a.alphaTarget(0),b.fx=null,b.fy=null})},r=function(e,r){d=e,h=r;var s=d,t=s.height,u=s.width,v=s.data,w=s.colors,x=s.colorDefault,y=s.linkColor,z=s.nodeBorderColor,A=s.sizes,B=s.onNodeClick,C=s.maxDiameter,D=s.minDiameter,E=s.collisionDistance,F=s.atractionStrength,G=s.withArrowHead,H=s.straightLink,I=[];if(v.links&&0!==v.links.length&&v.nodes&&0!==v.nodes.length){i(t,u),m(v),f=C,g=D,a.attrs({height:c,width:b});var J=v.links.map(function(a){return Object.create(a)}),K=v.nodes.map(function(a){return Object.create(a)}),L=D3.forceSimulation(K),M=a.append('svg:g').selectAll('path').data(J).enter().append('svg:path').attr('class','graph-link').attr('fill','none').attr('stroke-opacity',.6).attr('stroke-width',1.5).attr('stroke',y).style('stroke-width',2),N=a.append('g').attr('stroke',z).attr('stroke-width',1.5).selectAll('circle').data(K).join('circle').attr('r',function(a){var b=n(a,A);return I.includes(b)||I.push(b),b}).attr('fill',function(a){return o(a,w,x)}).attr('cursor','pointer').call(q(L)).on('click',B).on('mouseenter',function(a,b,c){var e=D3.select(c[b]);N.transition().style('opacity',.5),e.transition().style('opacity',1);var f=d,g=f.enableTooltip,i=f.tooltip,j=i?a:''+a.id;g&&h.tooltipState({tooltipContent:j,showTooltip:!0,tooltipX:D3.event.pageX,tooltipY:D3.event.pageY-28})}).on('mouseout',function(a,b,c){var e=D3.select(c[b]);N.transition().style('opacity',1),e.transition().style('opacity',1),d.enableTooltip&&h.tooltipState({showTooltip:!1})}),O=a.append('svg:defs').selectAll('marker').data(['end']).enter(),P=D3.forceLink(J).id(function(a){return a.id}),Q=D3.forceCollide().radius(function(a){return p(a,N,E)}),R=D3.forceCenter(b/2,c/2);j(F)&&P.strength(F),L.force('link',P).force('collision',Q).force('center',R),G&&I.forEach(function(a){O.append('svg:marker').attr('id','arrow'+a).attr('viewBox','0 -5 10 10').attr('refX',a+7).attr('markerWidth',6).attr('markerHeight',6).attr('orient','auto').append('svg:path').attr('d','M0,-5L10,0L0,5').attr('fill',y)}),L.on('tick',function(){M.attr('d',function(a){var d=a.target.x-a.source.x,e=a.target.y-a.source.y,f=parseInt(D3.select(N._groups[0][a.index]).attr('r'),10),g=a.x,h=a.y;g+f>b&&(g=b-f),h+f>c&&(h=c-f),0>g-f&&(g=0+f),0>h-f&&(h=0+f);var i=Math.sqrt(d*d+e*e);return H?'M'+a.source.x+','+a.source.y+'L'+a.target.x+' '+a.target.y:'M'+a.source.x+','+a.source.y+'A'+i+','+i+' 0 0,1 '+a.target.x+' '+a.target.y}),M.attr('marker-end',function(a){return'url(#arrow'+D3.select(N._groups[0][a.target.index]).attr('r')+')'}),N.attr('transform',function(a){return'translate('+k(N._groups[0],a.index,a.x)+','+l(N._groups[0],a.index,a.y)+')'})})}},s=function(b,c){d=b,h=c;var e=h,f=e.chart;D3.select(f).selectAll('*').remove(),a=D3.select(f).append('svg'),r(d,h)},t=function(b){D3.select(b).selectAll('*').remove(),a.remove()};return{create:s,update:r,destroy:t}})();